@component-name = "portal-ab-test"
definition {

	property analytics.cloud.enabled = "true";
	property minimum.slave.ram = "32";
	property portal.release = "false";
	property portal.upstream = "true";
	property testray.main.component.name = "A/B Test";

	setUp {

		// Open Analytics Cloud, login and take the token to connect to DXP

		var analyticsCloudURL = PropsUtil.get("analytics.cloud.url");
		Navigator.openURL(baseURL = "${analyticsCloudURL}");

		// Take token from Analytics Cloud

		AnalyticsCloud.loginAnalyticsCloud(
			emailAddress = "test@liferay.com",
			password = "test");

		AnalyticsCloud.takeTokenFromAnalyticsCloud();

		// Go to DXP portal

		TestCase.setUpPortalInstance();

		User.firstLoginPG();

		Navigator.openURL();

		JSONGroup.addGroup(groupName = "Test Site Name");

		// Connect and synchronyze with Analytics Cloud

		AnalyticsCloud.syncAnalyticsCloud(siteName = "Test Site Name");

		// Create content page

		JSONLayout.addPublicLayout(
			groupName = "Test Site Name",
			layoutName = "Content Page",
			type = "content");

		Navigator.openWithAppendToBaseURL(urlAppend = "web/test-site-name/content-page");
	}

	tearDown {
		var testPortalInstance = PropsUtil.get("test.portal.instance");

		Navigator.openURL();

		AnalyticsCloud.teardownAnalyticsCloud();

		JSONGroup.deleteGroupByName(groupName = "Test Site Name");

		if ("${testPortalInstance}" == "true") {
			PortalInstances.tearDownCP();
		}
	}

	@description = "Validate if the user can create an A/B Test"
	@priority = "5"
	test CreateABTestByBounceRate {
		property minimum.slave.ram = "32";

		ABTest.createABTest(
			goal = "Bounce Rate",
			testTitle = "AB test title");

		ABTest.createVariant(variantName = "Variant name");

		ABTest.runTest();

		ABTest.checkAnalyticsCloudInfo(ABtestTitle = "AB test title");

		Navigator.openURL();

		Navigator.openWithAppendToBaseURL(urlAppend = "web/test-site-name/content-page");

		ABTest.terminateTest();
	}

	@description = "Validate if, in the AB Test by Click, the sidebar informs the user that the element id is mandatory"
	@priority = "5"
	test CreateABTestByClick {
		property minimum.slave.ram = "32";

		ContentPages.clickPencil();

		PageEditor.addFragment(
			collectionName = "Basic Components",
			fragmentName = "Button");

		Button.clickPublish();

		Navigator.openWithAppendToBaseURL(urlAppend = "web/test-site-name/content-page");

		ABTest.createABTest(
			goal = "Click",
			testTitle = "AB test title");

		ABTest.selectElementID();

		ABTest.createVariant(variantName = "Variant name");

		ABTest.runTest();

		ABTest.checkAnalyticsCloudInfo(ABtestTitle = "AB test title");

		Navigator.openURL();

		Navigator.openWithAppendToBaseURL(urlAppend = "web/test-site-name/content-page");

		ABTest.terminateTest();
	}

	@description = "Validate if, in the AB Test by Click, the sidebar informs the user that the element id is mandatory"
	@priority = "5"
	test CreateABTestByClickInvalidId {
		property minimum.slave.ram = "32";

		ABTest.createABTest(
			goal = "Click",
			testTitle = "AB test title");

		ABTest.writeId(elementId = "invalidID");

		ABTest.runTest();

		AssertElementPresent(locator1 = "ABTest#INVALID_ID_MESSAGE");
	}

	@description = "Validate if, in the AB Test, the sidebar informs the user that minimum one variant is mandatory to test against Control if the user add variants and remove all variants"
	@priority = "5"
	test CreateABTestRunWithDeletedVariants {
		property minimum.slave.ram = "32";

		ABTest.createABTest(
			goal = "Bounce Rate",
			testTitle = "AB test title");

		ABTest.createVariant(variantName = "Variant name");

		ABTest.deleteVariant();

		ABTest.runTest();

		AssertTextEquals(
			locator1 = "ABTest#VARIANT_NEEDED_MESSAGE",
			value1 = "A variant needs to be created.");
	}

	@description = "Validate if, in the AB Test, the sidebar informs the user that minimum one variant is mandatory to test against Control"
	@priority = "5"
	test CreateABTestRunWithNoVariants {
		property minimum.slave.ram = "32";

		ABTest.createABTest(
			goal = "Bounce Rate",
			testTitle = "AB test title");

		ABTest.runTest();

		AssertTextEquals(
			locator1 = "ABTest#VARIANT_NEEDED_MESSAGE",
			value1 = "A variant needs to be created.");
	}

}